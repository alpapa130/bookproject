{% load static %}
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex">
    <title>{% block title %}{% endblock title %}|IT Bookfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{% static 'book/css/style.css' %}">
  </head>
  <body>
    {# サイト共通ヘッダー。ロゴ・検索・書籍登録・アカウントエリアを横並びにする #}
    <header class="site-header">
      {% if request.resolver_match %}
        {# 現在ページごとに検索先を切り替え。トップと一覧で挙動を揃える #}
        {% if request.resolver_match.url_name == 'list-book' %}
          {% url 'book:list-book' as search_action %}
        {% elif request.resolver_match.url_name == 'index' %}
          {% url 'book:index' as search_action %}
        {% else %}
          {% url 'book:list-book' as search_action %}
        {% endif %}
      {% else %}
        {% url 'book:list-book' as search_action %}
      {% endif %}
      <div class="site-header__inner">
        {# サイト名のロゴリンク #}
        <div class="site-header__brand">
          <a class="brand" href="{% url 'book:index' %}">IT Bookfolio</a>
        </div>
        <div class="site-header__actions">
          <a class="btn ghost site-header__create" href="{% url 'book:create-book' %}">書籍登録</a>
          {% if request.user.is_authenticated %}
            <form method="post" action="{% url 'accounts:logout' %}" class="site-header__logout">
              {% csrf_token %}
              <button type="submit" class="btn ghost">ログアウト</button>
            </form>
          {% else %}
            <a class="btn ghost site-header__login" href="{% url 'accounts:login' %}">ログイン</a>
            <a class="btn primary site-header__signup" href="{% url 'accounts:signup' %}">会員登録</a>
          {% endif %}
        </div>
        {# 検索フォーム。空入力で送信されたときは /book/ へ遷移させるため data 属性を付与 #}
        <form role="search" method="get" action="{{ search_action }}" class="site-header__search" data-search-form data-default-list-url="{% url 'book:list-book' %}">
          {% with header_query=current_query|default:'' %}
            <label for="site-search" class="sr-only">書籍名で検索</label>
            <input id="site-search" type="search" name="q" value="{{ header_query }}" placeholder="書籍名で検索">
          {% endwith %}
          {% with header_category=current_category|default:'' %}
            {% if header_category %}
              <input type="hidden" name="cat" value="{{ header_category }}">
            {% endif %}
          {% endwith %}
          <button type="submit">検索</button>
        </form>
        {% if request.user.is_authenticated %}
          <div class="site-header__welcome">こんにちは、<a href="{% url 'accounts:profile-edit' %}">{{ request.user.username }}</a> さん</div>
        {% endif %}
      </div>
    </header>
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash flash--{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    <main class="page">
      {% block content %}{% endblock content %}
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    {# 検索フォームでキーワード未入力だった場合に /book/ へリダイレクトする補助スクリプト #}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const searchForm = document.querySelector('[data-search-form]');
        if (searchForm) {
          searchForm.addEventListener('submit', function (event) {
            const input = searchForm.querySelector('input[name="q"]');
            const query = input ? input.value.trim() : '';
            if (!query) {
              event.preventDefault();
              const fallback = searchForm.dataset.defaultListUrl;
              if (fallback) {
                window.location.href = fallback;
              }
            }
          });
        }
      });
    </script>
    {% block extra_scripts %}{% endblock extra_scripts %}
  </body>
</html>
